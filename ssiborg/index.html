<!doctype html>
<html>
<head>
<title>ssiborg</title>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="jquery.flot.min.js"></script>
<script type="text/javascript" src="jquery.flot.selection.min.js"></script>
<style type="text/css">
* {
	font-family:monospace;
	box-sizing:border-box;
}
html, body {
	margin:0;
	padding:0;
	width:100%;
	height:100%;
}

#lay {
	border-collapse:collapse;
}
#lay td {
	padding:0;
	margin:0;
}
#sidebar {
	margin:0;
	padding:0;
}
#sidebar li {
	list-style-type: none;
}
#sidebar li:hover {
	background:rgba(0,0,0,.2);
}
.color-1 {
	background:#263238;
	color:white;
}
.color-2 {
	background:#455a64;
}
.color-3 {
	background:#37474f;
	color:white;
}
.color-4 {
	background:#00796b;
}
.nav-btns {
	margin:5px;
	display:inline-block;
}
.nav-btns button {
	height:1.5em;
	vertical-align:middle;
	font-size:200%;
	cursor:pointer;
	background:#37474f;
	color:white;
	margin:0;
	border:1px solid #263238;
}
.nav-btns button:last-child {
	border-left:none;
}
.nav-btns button:first-child {
	border-left:1px solid #263238 !important;
}
.nav-btns button:hover {
	background:#263238;
}
#links-setup {
	display:inline;
}
#links-setup a {
	color:white;
	text-decoration:none;
	font-weight:normal;
}
#links-setup a:hover {
	text-decoration:underline;
}
</style>
</head>
<body>
<!-- that's right, it's 2018 and I'M USING TABLES FOR LAYOUT -->
<div style="display:flex; flex-direction:row;height:100%;">
<div style="flex:0;max-height:100%;">
<div style="height:100%; display:flex; flex-direction:column;width:24em;">
<div style="padding:5px;padding-right:0px;min-height:3.5em;max-height:3.5em;flex:0;" id="head1" class="color-1">
<input style="width:100%;font-size:150%;background:white;border:1px solid black; padding:5px;" placeholder="Filter" id="filter">
</div>

<div style="flex:1 1 auto;min-height:0px;overflow-y:auto;" class="color-3">
<ul id="sidebar"></ul>
</div>

</div>

</div>

<div style="flex:1;margin:0; padding:0;" class="color-2">

<div style="margin:0; padding:0; padding-left:10px; height:3.5em;line-height:3.5em;vertical-align:top;" id="head2" class="color-1">
<div style="font-weight:bold;font-size:150%;">
ssiborg
<select style="font-size:100%;margin-left:10px;" id="frames">
<option>Loading...</option>
</select>
<div style="font-size:66.6%;font-weight:bold;" id="links-setup">
<a href="" id="btn-config">Config</a> &middot;
<a href="" id="btn-help">Help</a>
</div>
<div style="position:absolute;right:10px;top:0px;height:3.5em;font-size:66.6%;">
<div style="position:relative;transform:translateY(-50%);top:50%;">
<div style="line-height:normal;text-align:right;font-size:80%;font-weight:normal;" id="info"></div>
<div style="line-height:normal;text-align:right;font-size:80%;font-weight:normal;" id="info2"></div>
</div>
</div>
</div>

</div>

<div style="display:flex; flex-direction: column;height:calc(100% - 3.5em);"> <!-- or row -->
<div style="flex:0;flex-grow:1;overflow:hidden;" id="plot-area">
	<div id="plot-parent" style="text-align:center;">
	<div id="plot" style="text-align:center;height:400px; width:600px;background:#a2adb2;margin:0 auto;" class="color-3">
<pre style="font-size:90%;">



   ___    ___    ___   _                     __ _  
  / __|  / __|  |_ _| | |__    ___     _ _  / _` | 
  \__ \  \__ \   | |  | '_ \  / _ \   | '_| \__, | 
  |___/  |___/  |___| |_.__/  \___/  _|_|_  |___/  
_|"""""_|"""""_|"""""_|"""""_|"""""_|"""""_|"""""| 
"`-0-0-"`-0-0-"`-0-0-"`-0-0-"`-0-0-"`-0-0-"`-0-0-' 


</pre>
Powered by Xandri
<br>
<br>
Hailed as the new benchmark for shitty code
</div>
	</div>
</div>
<div style="flex:1;padding:10px;padding-top:5px;text-align:center;flex-grow:0;">
	<div class="nav-btns">
		<button>&#8962;</button>
	</div>
	<div class="nav-btns">
		<button>&larr;</button><button>&rarr;</button>
	</div>

	<style>
		#axes {
			margin:0 auto;
			text-align:left;
			border-spacing:0 5px;
		}
		.axis {
			padding:3px 0px;
			max-width:90%;
		}
		.axis-label {
			background:#263238;
			padding:5px;
			width:10em;
			max-width:10em;
			text-align:left;
			color:white;
			font-weight:bold;
		}
		.axis-key {
			display:inline-block;
			background:#37474f;
			margin:2px;
			color:white;
			line-height:100%;
			vertical-align:middle;
		}
		.axis-keys {
			border:1px solid #263238;
			min-width:10em;
		}
		.axis-opts {
			float:right;
			cursor:pointer;
			padding:5px;
			background:#a2adb2;
			color:black;
		}
		.axis-name {
			float:left;
			padding:5px;
		}
	</style>

	<table id="axes"> </table>
</div>
</div>

</div>

</div>
<script type="text/javascript">
var BASE = "http://localhost:2718";
if (window.location.href.indexOf("ssi-server4") != -1) {
	BASE = "http://ssi-server4.stanford.edu:443";
}
var sidebar = document.getElementById("sidebar");
var frames = document.getElementById("frames");
var filter = document.getElementById("filter");
var head1 = document.getElementById("head1");
var head2 = document.getElementById("head2");
var plot = document.getElementById("plot");
var banner = plot.innerHTML;
var plotP = document.getElementById("plot-parent");
var plotA = document.getElementById("plot-area");
var info = document.getElementById("info");
var info2 = document.getElementById("info2");
var btnhelp = document.getElementById("btn-help");
var btnconfig = document.getElementById("btn-config");
var axes = document.getElementById("axes");
var latency = {max: 0, sum: 0, num: 0};

/*var data = [
	{ data: [[0,0],[1,1]], label: "", xaxis: 1 },
	{ data: [[0.1,1.1], [1.1, 0.9]], label: "", yaxis: 2 },
	{ data: [[0.1,1.1], [1.1, 0.9]], label: "", yaxis: 2 },
	{ data: [[0.1,1.1], [1.1, 0.9]], label: "", yaxis: 3 }
];*/

var env = {keys: {}, indices: {}, frames: [], plots: [], frame: null, selection: [0, -1], points: 200, filter: null, axes: [{name: "Axis 1", position: "left"}]};
var flot = {data: [], opts: {
	xaxes: [ {  } ],
	yaxes: [ { alignTicksWithAxis: 1 } ],
	legend: {show: false},
	selection: { mode: "xy" }
}, plot: null};

/*, {
		// align if we are to the right
		alignTicksWithAxis: 1,
		position: "right",
	}*/

var cache = {indices: {}, keys: {}};


function clear() {
	sidebar.innerHTML = "";
	num = 0;
}

function load_index(idx, ret) {
	console.log("loading index", idx);
	var xhr = new XMLHttpRequest();
	xhr.open('GET', BASE + '/index/'+env.frame+'/'+idx+'/'+env.selection[0]+'/'+env.selection[1]+'/'+env.points, true);
	xhr.responseType = 'arraybuffer';

	var st = Date.now();
	xhr.onload = function(e) {
		if (this.status == 200) {
			update_latency(Date.now()-st);
			var buf = xhr.response;
			var type = eval("Uint"+(8*env.indices[idx].width)+"Array");
			var arr = new type(buf);
			var meta = JSON.parse(xhr.getResponseHeader('Xandri-Data'));
			cache.indices[idx] = {data: arr, zoom: meta[0], low: meta[1], high: meta[2]};
			ret();
		}
	};

	xhr.send();
}

function load_key(k, ret) {
	console.log("loading key", k);
	var key = env.keys[k];
	var idx = cache.indices[key.index];
	var xhr = new XMLHttpRequest();
	xhr.open('GET', BASE + '/key/'+env.frame+'/'+k+'/'+idx.zoom+'/'+idx.low+'/'+idx.high, true);
	xhr.responseType = 'arraybuffer';

	var st = Date.now();
	xhr.onload = function(e) {
		if (this.status == 200) {
			update_latency(Date.now()-st);
			var buf = xhr.response;
			var type = eval(key.type+"Array");
			var arr = new type(buf);
			cache.keys[k] = arr;
			ret();
		}
	};

	xhr.send();
}

function index_is_valid(idx) {
	var icache = cache.indices[idx];
	if (icache.zoom == 0) return true;
	var num = 0;
	for (var i=0; i<icache.data.length; i++) {
		var e = icache.data[i];
		if (e >= env.selection[0] && e <= env.selection[1]) num++;
	}
	return num >= env.points;
}

function update_zoom() {
	var indices = {};
	var num_ok = 0;
	for (var i=0; i<env.plots.length; i++) {
		var plot = env.plots[i];
		if (indices[plot.index] == false) {
			num_ok++;
			continue;
		}
		if (!indices[plot.index]) {
			var valid = index_is_valid(plot.index);
			if (valid) {
				indices[plot.index] = false;
				num_ok++;
				continue;
			}
			indices[plot.index] = [];
		}
		indices[plot.index].push(plot.key);
	}
	var st = Date.now();
	function update_arrays() {
		if (num_ok != env.plots.length) return;
		update_latency(Date.now()-st);
		console.log("updated all indices!");
		var xaxis = {};
		for (var i=0; i<env.plots.length; i++) {
			var plot = env.plots[i];
			var x = xaxis[plot.index];
			if (!x) {
				var icache = cache.indices[plot.index];
				x = [];
				for (var j=0; j<icache.data.length; j++) {
					var e = icache.data[j];
					if (e >= env.selection[0] && e <= env.selection[1]) x.push([j, e]);
				}
				xaxis[plot.index] = x;
			}
			var lst = [];
			for (var j=0; j<x.length; j++) {
				lst.push([x[j][1], cache.keys[plot.key][x[j][0]]]);
			}
			flot.data[i].data = lst;
		}
		mkplot();
	}
	function key_loader(lst) {
		return function () {
			for (var i=0; i<lst.length; i++) {
				load_key(lst[i], function () {
					num_ok++;
					update_arrays();
				});
			}
		}
	}
	for (var idx in indices) {
		var lst = indices[idx];
		if (indices[idx]) load_index(idx, key_loader(lst));
	}
	update_arrays();
}

function add_key(k) {
	var key = env.keys[k];
	function _add_key() {
		var icache = cache.indices[key.index];
		if (env.selection[1] == -1) {
			env.selection = [icache.data[icache.low], icache.data[icache.high]];
		}
		function __add_key() {
			var lst = [];
			var dcache = cache.keys[k];
			for (var i=0; i<dcache.length; i++) {
				var e = icache.data[i];
				if (e >= env.selection[0] && e <= env.selection[1])
					lst.push([e, dcache[i]]);
			}
			flot.data.push({data: lst, label: k, yaxis: env.axes.length});
			env.plots.push({key: k, index: key.index, axis: env.axes.length});
			mkplot();
			render_axes();
		}
		if (!cache.keys[k]) load_key(k, __add_key);
		else __add_key();
	}
	if (!cache.indices[key.index]) load_index(key.index, _add_key);
	else _add_key();
}

function remove_key(k) {
	for (var i=0; i<env.plots.length; i++) {
		if (env.plots[i].key == k) {
			env.plots.splice(i, 1);
			flot.data.splice(i, 1);
			mkplot();
			break;
		}
	}
	render_axes();
}

function render_sidebar() {
	sidebar.innerHTML = "";
	var sorted = Object.keys(env.keys).sort();
	for (var i=0; i<sorted.length; i++) {
		var key = sorted[i];
		if (env.filter && !env.filter.test(key)) continue;
		var li = document.createElement("li");
		li.style.display="block";
		var sel = env.keys[key].selected;
		var str = '<div style="display:flex;flex-direction:row;width:100%;"'+(sel?' class="color-4"':'')+'><div style="flex:0;"><input'+(sel?' checked':'')+' style="margin-top:6px;" id="chk-'+i+'" type="checkbox" data-key="'+key+'"></div>';
		str += '<div style="flex:1;overflow-x:hidden;display:block;"><label style="text-overflow:ellipsis;white-space:nowrap;width:100%;padding:5px;display:block;" for="chk-'+i+'">'+key+'</label></div>';
			/*str += '<div style="flex:0; min-width:2em;';
			if (sel) {
				if (Math.random() > 0.5) {
					c = 'darkred';
				} else c = 'darkblue';
				str += 'background:'+c+';';
			}
			str += '"></div>'*/
		str += '</div>';
		li.innerHTML = str;
		sidebar.appendChild(li);
		document.getElementById("chk-"+i).addEventListener('change', function () {
			var key = this.getAttribute('data-key');
			if (this.checked) {
				env.keys[key].selected = true;
				this.parentNode.parentNode.className = "color-4";
				add_key(key);
			} else {
				remove_key(key);
				env.keys[key].selected = false;
				this.parentNode.parentNode.className = "";
			}
		});
	}
}

function render_frames(list) {
	var str = '';//<option>Select</option>';
	for (var i=0; i<env.frames.length; i++) {
		str += '<option>'+env.frames[i]+'</option>';
	}
	frames.innerHTML = str;
}

function render_axes() {
	var s = "";
	axes.innerHTML = s;

	var vars = [];
	for (var k=0; k<env.axes.length; k++) vars.push([]);
	for (var i=0; i<env.plots.length; i++) {
		vars[env.plots[i].axis-1].push(i);
	}

	for (var i=0; i<env.axes.length; i++) {
		var ax = env.axes[i];

		var tr = document.createElement("tr");
		tr.className = "axis";

		var td = document.createElement("td");
		td.className = "axis-label";
		var name = document.createElement("span");
		name.className = "axis-name";
		name.appendChild(document.createTextNode(ax.name));
		td.appendChild(name);
		var opts = document.createElement("span");
		opts.className = "axis-opts";
		opts.innerHTML = "&#9650;";
		opts.addEventListener("click", (function (name) { return function () {
			alert("options for "+name);
		}})(ax.name));
		td.appendChild(opts);
		tr.appendChild(td);

		var td = document.createElement("td");
		td.className = "axis-keys";
		for (var j=0; j<vars[i].length; j++) {
			var ki = vars[i][j];
			var k = env.plots[ki].key;
			var div = document.createElement("div");
			div.className = "axis-key";

			var col = document.createElement("span");
			col.style.display = "inline";
			col.style.minWidth = "10px";
			col.style.width = "10px";
			col.style.padding = "5px 8px";
			col.style.background = env.plots[ki].color;
			console.log(env.plots[ki].color);
			div.appendChild(col);

			var txt = document.createElement("span");
			txt.style.padding = "5px";
			txt.style.display = "inline-block";
			txt.appendChild(document.createTextNode(k));
			div.appendChild(txt);

			td.appendChild(div);
		}
		tr.appendChild(td);

		axes.appendChild(tr);
	}
	var tr = document.createElement("tr");
	tr.className = "axis";
	var td = document.createElement("td");
	td.className = "axis-label";
	td.style.cursor = "pointer";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.appendChild(document.createTextNode("New axis"));
	td.addEventListener('click', new_axis);
	td.appendChild(span);
	tr.appendChild(td);
	axes.appendChild(tr);
}

function new_axis() {
	env.axes.push({name: "Axis "+(env.axes.length+1), position: "left"});
	flot.opts.yaxes.push({alignTicksWithAxis: 1});
	render_axes();
}

render_axes();

function update_latency(lat) {
	latency.sum += lat;
	latency.num++;
	latency.max = Math.max(latency.max, lat);
	info.innerHTML = 'Latency [last/mean/max]: ' + lat + '/'+Math.round(latency.sum/latency.num)+'/'+latency.max + ' ms';
	if (Object.keys(cache.indices).length > 0) {
		var idx = cache.indices[Object.keys(cache.indices)[0]];
		info2.innerHTML = 'Zoom: '+idx.zoom+', points: '+idx.data.length;
	}
}

function select(v) {
	env.frame = v;
	var st = Date.now();
	$.getJSON(BASE+'/keys/'+v, function (data) {
		update_latency(Date.now()-st);
		env.indices = {};
		for (var i=0; i<data.indices.length; i++) {
			env.indices[data.indices[i].name] = {width: data.indices[i].width};
		}
		var keys = data.keys;
		env.keys = {};
		for (var i=0; i<keys.length; i++) {
			var t = keys[i][1];
			var w = keys[i][2];
			var s = ["Int","Float"][t] + {1: "8", 2: "16", 4: "32", 8: "64"}[w];
			env.keys[keys[i][0]] = {index: keys[i][3], type: s, selected: false};
		}
		render_sidebar();
	});	
}

function mkplot() {
	if (flot.data.length != 0) {
		plot.innerHTML = "";
		flot.plot = $.plot("#plot", flot.data, flot.opts);
		$("#plot").unbind("plotselected").bind("plotselected", function (event, ranges) {
			flot.opts.xaxes[0].min = ranges.xaxis.from;
			flot.opts.xaxes[0].max = ranges.xaxis.to;
			env.selection = [Math.floor(ranges.xaxis.from), Math.ceil(ranges.xaxis.to)];
			update_zoom();
			mkplot();
			console.log("selected", ranges);
		});
		var data = flot.plot.getData();
		for (var i=0; i<data.length; i++) {
			env.plots[i].color = data[i].color;
		}

	} else
		plot.innerHTML = banner;
}

var clearint;

function resize() {
	console.log("onresize");
	plot.innerHTML = banner;
	plot.style.width = "0px";
	plot.style.height = "0px";
	clearTimeout(clearint);
	clearint = setTimeout(function() {
		var h = plotA.clientHeight;
		var w = plotA.clientWidth;
		env.points = w;
		console.log(h,w)
		plot.style.width = ""+w+"px";
		plot.style.height = ""+h+"px";
		plotP.style.paddingTop = "" + ((plotA.clientHeight-h)/2.) + "px";
		mkplot();
	}, 100);
}

clear();
resize();

window.addEventListener('resize', resize);

var st = Date.now();
$.getJSON(BASE+"/frames", function (fr) {
	update_latency(Date.now()-st);
	env.frames = fr;
	render_frames();
	select(fr[0]);
});

filter.addEventListener("keyup", function () {
	if (this.value.length == 0) env.filter = null;
	else env.filter = new RegExp(this.value, 'i');
	render_sidebar();
});

btnhelp.addEventListener("click", function (e) {
	e.preventDefault();
	alert("I appreciate your faith. But no, no help yet.");
});

btnconfig.addEventListener("click", function (e) {
	e.preventDefault();
	alert("lol");
});

/*for (var i=0; i<60; i++) {
	add_to_sidebar("lol"+i);
}*/
</script>
</body>
</html>
