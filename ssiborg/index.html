<!doctype html>
<html>
<head>
<meta charset="UTF-8">
<title>ssiborg</title>
<script type="text/javascript" src="long.js"></script>
<script type="text/javascript" src="jquery.min.js"></script>
<script type="text/javascript" src="jquery.flot.min.js"></script>
<script type="text/javascript" src="jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="jquery.flot.crosshair.js"></script>
<script type="text/javascript" src="jquery.flot.log.js"></script>
<script type="text/javascript" src="jquery.flot.axislabels.js"></script>
<script async type="text/javascript" src="http://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
<style type="text/css">
* {
	font-family:monospace;
	box-sizing:border-box;
}
html, body {
	margin:0;
	padding:0;
	width:100%;
	height:100%;
}

#lay {
	border-collapse:collapse;
}
#lay td {
	padding:0;
	margin:0;
}
#sidebar {
	margin:0;
	padding:0;
}
#sidebar li {
	list-style-type: none;
}
#sidebar li:hover {
	background:rgba(0,0,0,.2);
}
.color-1 {
	background:#263238;
	color:white;
}
.color-2 {
	background:#455a64;
	/*background:#FFFFFF*/
}
.color-3 {
	background:#37474f;
	/*background:#FFFFFF*/
	color:white;
}
.color-4 {
	background:#00796b;
}
.nav-btns {
}
.nav-btns button {
	vertical-align:middle;
	font-size:200%;
	cursor:pointer;
	background:#37474f;
	color:white;
	margin:0;
	border:1px solid #263238;
	font-size: 100%;
	padding:2px;
	width:100%;
	margin:2.5px 0px;
}
.nav-btns button:hover {
	background:#263238;
}
.nav-btns-pressed{
	background:#263238 !important;
}
#links-setup {
	display:inline;
}
#links-setup a {
	color:white;
	text-decoration:none;
	font-weight:normal;
}
#links-setup a:hover {
	text-decoration:underline;
}
</style>
</head>
<body>
<!-- that's right, it's 2018 and I'M USING TABLES FOR LAYOUT -->
<div style="display:flex; flex-direction:row;height:100%;">
<div style="flex:0;max-height:100%;">
<div style="height:100%; display:flex; flex-direction:column;width:24em;">
<div style="padding:5px;padding-right:0px;min-height:3.5em;max-height:3.5em;flex:0;" id="head1" class="color-1">
<input style="width:100%;font-size:150%;background:white;border:1px solid black; padding:5px;" placeholder="Filter" id="filter">
</div>

<div style="flex:1 1 auto;min-height:0px;overflow-y:auto;" class="color-3">
<ul id="sidebar"></ul>
</div>

</div>

</div>

<div style="flex:1;margin:0; padding:0;" class="color-2">

<div style="margin:0; padding:0; padding-left:10px; height:3.5em;line-height:3.5em;vertical-align:top;" id="head2" class="color-1">
<div style="font-weight:bold;font-size:150%;">
ssiborg
<select style="font-size:100%;margin-left:10px;" id="frames">
<option>Loading...</option>
</select>
<div style="font-size:66.6%;font-weight:bold;" id="links-setup">
<a href="" id="btn-config">Config</a> &middot;
<a href="" id="btn-help">Help</a>
</div>
<div style="position:absolute;right:10px;top:0px;height:3.5em;font-size:66.6%;">
<div style="position:relative;transform:translateY(-50%);top:50%;">
<div style="line-height:normal;text-align:right;font-size:80%;font-weight:normal;" id="info"></div>
<div style="line-height:normal;text-align:right;font-size:80%;font-weight:normal;" id="info2"></div>
</div>
</div>
</div>

</div>

<div style="display:flex; flex-direction: column;height:calc(100% - 3.5em);" id="yeet"> <!-- or row -->
<div style="flex:0;flex-grow:1;overflow:hidden;position:relative" id="plot-area">
	<div id="plot-parent" style="text-align:center;">
	<div id="axis-container" style="z-index:1"> </div>
	<div id="plot" style="color:black !important;text-align:center;height:400px; width:600px;background:#a2adb2;margin:0 auto;" class="color-3">
<pre style="font-size:90%;">



   ___    ___    ___   _                     __ _  
  / __|  / __|  |_ _| | |__    ___     _ _  / _` | 
  \__ \  \__ \   | |  | '_ \  / _ \   | '_| \__, | 
  |___/  |___/  |___| |_.__/  \___/  _|_|_  |___/  
_|"""""_|"""""_|"""""_|"""""_|"""""_|"""""_|"""""| 
"`-0-0-"`-0-0-"`-0-0-"`-0-0-"`-0-0-"`-0-0-"`-0-0-' 


</pre>
Powered by Xandri
<br>
<br>
Hailed as the new benchmark for shitty code
</div>
	</div>
</div>
<div style="flex:1;text-align:center;flex-grow:0;">
	<style>
		#axes {
			margin:0 auto;
			text-align:center;
			border-spacing:0 5px;
			font-size:85%;
		}
		.axis {
			padding:0px 0px;
			display:inline-block;
			margin-right:6px;
			margin-left:6px;
		}
		.axis-label {
			background:#263238;
			padding:4px;
			text-align:left;
			color:white;
			font-weight:bold;
		}
		.axis-key {
			display:inline-block;
			background:#37474f;
			margin:2px;
			color:white;
			line-height:100%;
			vertical-align:middle;
		}
		.axis-keys {
			border:1px solid #263238;
			min-width:10em;
		}
		.axis-opts {
			float:right;
			cursor:pointer;
			padding:4px;
			margin-left:4px;
			background:#a2adb2;
			color:black;
		}
		.axis-name {
			float:left;
			padding:4px;
		}
		.axis-nav {
			cursor:pointer;
			padding:0;
			height:30px;/ /* lol */
		}
		.axis-nav span {
			min-width:1.75em;
			text-align:center;
			background:#37474f;
			border:1px solid #263238;
			border-left:none;
			color:white;
			font-size:150%;
			font-weight:bold;
			display:inline-block;
			height:100%;
		}
		.axis-new-sec span {
			border-left:1px solid #263238 !important;
		}
		.axis-new-sec {
			padding-left:5px;
		}
	</style>

	<table id="axes">
	
	</table>
</div>
</div>

</div>

</div>
<script type="text/javascript">

var Uint64Array = function(buf) {
	var arr = new Uint8Array(buf);
	var lst = 0;
	var len = arr.length/8;
	var out = new Float64Array(len);
	for (var i=0; i<len; i++) {
		out[i] = Long.fromBytesLE(arr.slice(8*i, 8*i+8));
	}
	return out;
}

var BASE = "http://localhost:2718";
BASE = "http://"+window.location.hostname+":443";
var sidebar = document.getElementById("sidebar");
var frames = document.getElementById("frames");
var filter = document.getElementById("filter");
var head1 = document.getElementById("head1");
var head2 = document.getElementById("head2");
var plot = document.getElementById("plot");
var banner = plot.innerHTML;
var plotP = document.getElementById("plot-parent");
var plotA = document.getElementById("plot-area");
var info = document.getElementById("info");
var info2 = document.getElementById("info2");
var btnhelp = document.getElementById("btn-help");
var btnconfig = document.getElementById("btn-config");
var axes = document.getElementById("axes");
var latency = {max: 0, sum: 0, num: 0};

/*var data = [
	{ data: [[0,0],[1,1]], label: "", xaxis: 1 },
	{ data: [[0.1,1.1], [1.1, 0.9]], label: "", yaxis: 2 },
	{ data: [[0.1,1.1], [1.1, 0.9]], label: "", yaxis: 2 },
	{ data: [[0.1,1.1], [1.1, 0.9]], label: "", yaxis: 3 }
];*/

var env = { keys: {},
			indices: {},
			frames: [],
			plots: [],
			frame: null,
			selection: [0, -1],
			points: 200,
			filter: null,
			axes: [{name: undefined, position: "left"}],
			bounds: {},
			nav: {cur: 0, history: [[0, -1]]},
			bytes: 0
			};
var flot = {data: [], opts: {
	axisLabels: {
		show: true,
	},
	xaxes: [ {  } ],
	yaxes: [ { alignTicksWithAxis: 1 } ],
	legend: {show: false},
	selection: { mode: "xy" },
	crosshair: { mode: null,
			 color: "rgba(100, 100, 100, 0.50)",
			 lineWidth: 2
		   },
	grid:{	autoHighlight:true, 
			hoverable:true, 
			clickable:true, 
			axisMargin:10, 
			borderWidth:1
		}
}, plot: null};

flot.opts.xaxes[0].tickFormatter = function (a, _) {
	return Math.round(a/60000.*100)/100;
}

var config = {
	CACHE_SIZE: 8
}

/*, {
		// align if we are to the right
		alignTicksWithAxis: 1,
		position: "right",
	}*/

var cache = {indices: {}, keys: {}, old: []};


function clear() {
	sidebar.innerHTML = "";
	num = 0;
}

function load_index(idx, ret) {
	for (var i=0; i<cache.old.length; i++) {
		var old = cache.old[i];
		if (old[0][0] == idx && _index_is_valid(old[1])) {
			cache.indices[idx] = old[1];
			console.log("loaded from cache!");
			ret();
			return;
		}
	}

	var xhr = new XMLHttpRequest();
	xhr.open('GET', BASE + '/index/'+env.frame+'/'+idx+'/'+env.selection[0]+'/'+env.selection[1]+'/'+env.points, true);
	xhr.responseType = 'arraybuffer';

	var st = Date.now();
	xhr.onload = function(e) {
		if (this.status == 200) {
			update_latency(Date.now()-st);
			var buf = xhr.response;
			env.bytes += buf.byteLength;
			var type = eval("Uint"+(8*env.indices[idx].width)+"Array");
			var arr = new type(buf);
			var meta = JSON.parse(xhr.getResponseHeader('Xandri-Data'));
			cache.indices[idx] = {data: arr, zoom: meta[0], low: meta[1], high: meta[2]};
			var icache = cache.indices[idx];
			if (!env.bounds[idx]) env.bounds[idx] = [Infinity, -Infinity];
			env.bounds[idx][0] = Math.min(env.bounds[idx][0], icache.data[0]);
			env.bounds[idx][1] = Math.max(env.bounds[idx][1], icache.data[icache.data.length-1]);
			cache.old.unshift([[idx, meta[0], meta[1], meta[2]], cache.indices[idx], {}]);
			if (cache.old.length >= config.CACHE_SIZE) {
				cache.old = cache.old.slice(0, config.CACHE_SIZE);
			}
			if (env.selection[1] == -1) {
				env.selection = [icache.data[0], icache.data[icache.data.length-1]];
			}
			ret();
		}
	};

	xhr.send();
}

function load_key(k, ret) {
	var key = env.keys[k];
	var idx = cache.indices[key.index];
	for (var i=0; i<cache.old.length; i++) {
		var old = cache.old[i];
		if (old[0][0] == key.index &&
			old[0][1] == idx.zoom &&
			old[0][2] == idx.low &&
			old[0][3] == idx.high &&
			k in old[2]) {
			console.log("loaded key from cache!");
			cache.keys[k] = old[2][k];
			ret();
			return;
		}
	}
	var xhr = new XMLHttpRequest();
	xhr.open('GET', BASE + '/key/'+env.frame+'/'+k+'/'+idx.zoom+'/'+idx.low+'/'+idx.high, true);
	xhr.responseType = 'arraybuffer';

	var st = Date.now();
	xhr.onload = function(e) {
		if (this.status == 200) {
			update_latency(Date.now()-st);
			var buf = xhr.response;
			env.bytes += buf.byteLength;
			var type = eval(key.type+"Array");
			var arr = new type(buf);
			cache.keys[k] = arr;
			for (var i=0; i<cache.old.length; i++) {
				var old = cache.old[i];
				if (old[0][0] == key.index &&
					old[0][1] == idx.zoom &&
					old[0][2] == idx.low &&
					old[0][3] == idx.high) {
					cache.old[i][2][k] = arr;
				}
			}
			ret();
		}
	};

	xhr.send();
}

function _index_is_valid(icache) {
	if (icache.data[0] > env.selection[0] || icache.data[icache.data.length-1] < env.selection[1])
		return false;
	if (icache.zoom == 0)
		return true;
	var num = 0;
	for (var i=0; i<icache.data.length; i++) {
		var e = icache.data[i];
		if (e >= env.selection[0] && e <= env.selection[1]) num++;
	}
	return num >= env.points;
}

function index_is_valid(idx) {
	var icache = cache.indices[idx];
	return _index_is_valid(icache);
}

function update_zoom() {
	var indices = {};
	var num_ok = 0;
	for (var i=0; i<env.plots.length; i++) {
		var plot = env.plots[i];
		if (indices[plot.index] == false) {
			num_ok++;
			continue;
		}
		if (!indices[plot.index]) {
			var valid = index_is_valid(plot.index);
			if (valid) {
				indices[plot.index] = false;
				num_ok++;
				continue;
			}
			indices[plot.index] = [];
		}
		indices[plot.index].push(plot.key);
	}
	var st = Date.now();
	function update_arrays() {
		if (num_ok != env.plots.length) return;
		update_latency(Date.now()-st);
		var xaxis = {};
		for (var i=0; i<env.plots.length; i++) {
			var plot = env.plots[i];
			var x = xaxis[plot.index];
			if (!x) {
				var icache = cache.indices[plot.index];
				x = [];
				for (var j=0; j<icache.data.length; j++) {
					var e = icache.data[j];
					if (e >= env.selection[0] && e <= env.selection[1]) x.push([j, e]);
				}
				xaxis[plot.index] = x;
			}
			var lst = [];
			for (var j=0; j<x.length; j++) {
				lst.push([x[j][1], cache.keys[plot.key][x[j][0]]]);
			}
			flot.data[i].data = lst;
		}
		mkplot();
	}
	function key_loader(lst) {
		return function () {
			for (var i=0; i<lst.length; i++) {
				load_key(lst[i], function () {
					num_ok++;
					update_arrays();
				});
			}
		}
	}
	for (var idx in indices) {
		var lst = indices[idx];
		if (indices[idx]) load_index(idx, key_loader(lst));
	}
	update_arrays();
}

function add_key(k) {
	var key = env.keys[k];
	function _add_key() {
		var icache = cache.indices[key.index];
		function __add_key() {
			var lst = [];
			var dcache = cache.keys[k];
			for (var i=0; i<dcache.length; i++) {
				var e = icache.data[i];
				if (e >= env.selection[0] && e <= env.selection[1])
					lst.push([e, dcache[i]]);
			}
			flot.data.push({data: lst, label: k, yaxis: env.axes.length});
			env.plots.push({key: k, index: key.index, axis: env.axes.length});
			mkplot();
			render_axes();
		}
		if (!cache.keys[k]) load_key(k, __add_key);
		else __add_key();
	}
	if (!cache.indices[key.index]) load_index(key.index, _add_key);
	else _add_key();
}

function remove_key(k) {
	for (var i=0; i<env.plots.length; i++) {
		if (env.plots[i].key == k) {
			env.plots.splice(i, 1);
			flot.data.splice(i, 1);
			mkplot();
			break;
		}
	}
	render_axes();
}

function render_sidebar() {
	sidebar.innerHTML = "";
	var sorted = Object.keys(env.keys).sort();
	for (var i=0; i<sorted.length; i++) {
		var key = sorted[i];
		if (env.filter && !env.filter.test(key)) continue;
		var li = document.createElement("li");
		li.style.display="block";
		var sel = env.keys[key].selected;
		var str = '<div style="display:flex;flex-direction:row;width:100%;"'+(sel?' class="color-4"':'')+'><div style="flex:0;"><input'+(sel?' checked':'')+' style="margin-top:6px;" id="chk-'+i+'" type="checkbox" data-key="'+key+'"></div>';
		str += '<div style="flex:1;overflow-x:hidden;display:block;"><label style="text-overflow:ellipsis;white-space:nowrap;width:100%;padding:5px;display:block;" for="chk-'+i+'">'+key+'</label></div>';
			/*str += '<div style="flex:0; min-width:2em;';
			if (sel) {
				if (Math.random() > 0.5) {
					c = 'darkred';
				} else c = 'darkblue';
				str += 'background:'+c+';';
			}
			str += '"></div>'*/
		str += '</div>';
		li.innerHTML = str;
		sidebar.appendChild(li);
		document.getElementById("chk-"+i).addEventListener('change', function () {
			var key = this.getAttribute('data-key');
			if (this.checked) {
				env.keys[key].selected = true;
				this.parentNode.parentNode.className = "color-4";
				add_key(key);
			} else {
				remove_key(key);
				env.keys[key].selected = false;
				this.parentNode.parentNode.className = "";
			}
		});
	}
}

function render_frames(list) {
	var str = '';//<option>Select</option>';
	for (var i=0; i<env.frames.length; i++) {
		str += '<option value="'+env.frames[i]+'">'+env.frames[i]+'</option>';
	}
	frames.innerHTML = str;
}

function go_home() {
	flot.opts.xaxes[0] = {};
	for (var i=0; i<env.plots.length; i++) {
		var idxbounds = env.bounds[env.plots[i].index];
		env.selection[0] = Math.min(idxbounds[0], env.selection[0]);
		env.selection[1] = Math.max(idxbounds[1], env.selection[1]);
	}
	env.nav.cur = 0;
	env.nav.history = [env.selection];
	update_zoom();
	mkplot();
}

function go_nav(delta) {
	var next = env.nav.cur + delta;
	if (next < 0 || next >= env.nav.history.length)
		return;
	env.nav.cur = next;
	env.selection = env.nav.history[next];
	if (env.selection[1] == -1) {
		flot.opts.xaxes[0] = {};
	} else {
			flot.opts.xaxes[0].min = env.selection[0];
			flot.opts.xaxes[0].max = env.selection[1];
	}
	update_zoom();
	mkplot();
}

$(document).click(function (e) {
	var hmm = document.getElementById("popup");
	if (!hmm) return;
	if (!($(e.target).is("#popup")||$(e.target).parents("#popup").length)){
		var e = new Event("keypress");
		e.which = 13;
		document.getElementById("popup-inp").dispatchEvent(e);
		$("#popup").remove();
	}
});

var oldnum = -1;
var oldheight = -1;
function render_axes() {
	var s = "";
	axes.innerHTML = s;
	var tr = document.createElement("tr");
	tr.className = "axis";

	var td = document.createElement("td");
	td.className = "axis-nav axis-new-sec";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.innerHTML = "&#8962;";
	span.addEventListener('click', go_home);
	td.appendChild(span);
	tr.appendChild(td);

	var td = document.createElement("td");
	td.className = "axis-nav axis-new-sec";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.innerHTML = "&#128247;";
	span.addEventListener('click', function() {
		var oldcolor = document.getElementById('plot').style.background;	
		document.getElementById('plot').style.background = "white";
		document.getElementsByClassName('axis')[0].style.display = "none";
		var nax = document.getElementsByClassName('axis').length;
		document.getElementsByClassName('axis')[nax-1].style.display = "none";
		var arrows = document.getElementsByClassName('axis-opts');
		for (var a=0; a<arrows.length; a++) arrows[a].style.display = "none";
		var an = document.getElementsByClassName('axis-name');
		for (var a=0; a<an.length; a++) { console.log(an[a], an[a].getAttribute('data-real')); if (an[a].hasAttribute('data-real')) an[a].innerHTML = an[a].getAttribute('data-real')}
		html2canvas(document.getElementById('yeet')).then(function (canvas) {
			document.getElementsByClassName('axis')[0].style.display = "inline-block";
			document.getElementsByClassName('axis')[nax-1].style.display = "inline-block";
			for (var a=0; a<arrows.length; a++) arrows[a].style.display = "inline";
			document.getElementById('plot').style.background = oldcolor;
			render_axes();
			var a = document.createElement('a');
			console.log(canvas);
			a.href = canvas.toDataURL("image/jpeg").replace("image/jpeg", "image/octet-stream");
			a.download = 'screenshot.jpg';
			var event = new MouseEvent('click');
			a.dispatchEvent(event);
			//a.click();
		})});
	td.appendChild(span);
	tr.appendChild(td);

	var td = document.createElement("td");
	td.className = "axis-nav axis-new-sec";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.innerHTML = "&larr;";
	span.addEventListener('click', function () { go_nav(-1); });
	td.appendChild(span);
	tr.appendChild(td);
	var td = document.createElement("td");
	td.className = "axis-nav";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.innerHTML = "&rarr;";
	span.addEventListener('click', function () { go_nav(1); });
	td.appendChild(span);
	tr.appendChild(td);

	var td = document.createElement("td");
	td.className = "axis-nav axis-new-sec";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.innerHTML = "&#65291;";
	td.appendChild(span);
	span.addEventListener("click", function () {
		if (this.classList.contains("nav-btns-pressed")) {
			this.classList.remove("nav-btns-pressed")
			flot.opts.crosshair.mode = null;
		} else {
			this.classList.add("nav-btns-pressed")
			flot.opts.crosshair.mode = "xy";
		}
		mkplot();
	});
	tr.appendChild(td);
	axes.appendChild(tr);

	var td = document.createElement("td");
	td.className = "axis-nav axis-new-sec";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.innerHTML = "&#10005;";
	td.appendChild(span);
	span.addEventListener("click", resetPopup);
	tr.appendChild(td);
	axes.appendChild(tr);

	var vars = [];
	for (var k=0; k<env.axes.length; k++) vars.push([]);
	for (var i=0; i<env.plots.length; i++) {
		vars[env.plots[i].axis-1].push(i);
	}

	for (var i=0; i<env.axes.length; i++) {
		var ax = env.axes[i];

		var tr = document.createElement("tr");
		tr.className = "axis";

		var td = document.createElement("td");
		td.className = "axis-label";
		td.style.cursor = "pointer";
		var name = document.createElement("span");
		name.className = "axis-name";
		name.appendChild(document.createTextNode(""+(i+1)));
		console.log("ax", ax);
		name.setAttribute("data-real", ax.name ? ax.name : (""+(i+1)));
		td.appendChild(name);
		var opts = document.createElement("span");
		opts.className = "axis-opts";
		opts.innerHTML = "&#9650;";
		opts.dataInernalid = i;
		td.addEventListener("click", (function (i) { return function (e) {
			e.preventDefault();
			e.stopPropagation();
			$("#popup").remove();
			var fullH = document.documentElement.clientHeight;
			var fullW = document.documentElement.clientWidth;
			var pos = this.getBoundingClientRect(); // .parentNode
			var pop = document.createElement("div");
			pop.style.position = "fixed";
			pop.style.bottom = (fullH - pos.top) + "px";
			pop.style.right = (fullW - pos.right) + "px";
			pop.style.padding = "5px";
			pop.style.background = "#455a64";
			pop.style.border = "1px solid #263238";
			pop.style.minWidth = "80px";
			pop.style.color = "white";
			pop.id = "popup";
			document.body.appendChild(pop);

			var btns = document.createElement("div")
			btns.className = "nav-btns";
			pop.appendChild(btns);
			var log_btn = document.createElement("button");
			if(env.axes[i].log){
				log_btn.classList.add("nav-btns-pressed");
			}
			log_btn.type = "button";
			log_btn.innerHTML = "log";
			log_btn.addEventListener("click", (function (i) { return function (e) { 
				if(env.axes[i].log){
					env.axes[i].log = false;
					flot.opts.yaxes[i].transform = undefined;
					flot.opts.yaxes[i].mode = undefined;
				} else {
					env.axes[i].log = true;
					flot.opts.yaxes[i].mode = 'log';
					flot.opts.yaxes[i].inverseTransform = function (v) {
						return Math.pow(10, v);
					}
					flot.opts.yaxes[i]["transform"] = function(v) {
						if (v > 0) {
							return Math.log(v);
						} else {
							return null;
						}
					};
				}
				this.classList.toggle("nav-btns-pressed");
				mkplot();
			}})(i));
			btns.appendChild(log_btn);

			var right_btn = document.createElement("button");
			if(env.axes[i].position == "right"){
				right_btn.classList.add("nav-btns-pressed");
			}
			right_btn.addEventListener("click", (function (i) { return function (e) {
				if (env.axes[i].position == "right") {
					env.axes[i].position = "left";
					flot.opts.yaxes[i].position = "left";
					this.classList.remove("nav-btns-pressed");
				} else {
					env.axes[i].position = "right";
					flot.opts.yaxes[i].position = "right";
					this.classList.add("nav-btns-pressed");
				}
				mkplot();
			}})(i));
			right_btn.innerHTML = "right side";
			btns.append(right_btn);

			var inp = document.createElement("input");
			inp.style.width = "100%";
			inp.style.padding = "5px";
			inp.style.marginTop = "5px";
			inp.placeholder = "Label";
			inp.addEventListener('keypress', (function (i) { return function(e) {
				var c = e.keycode || e.which;
				if (c == 13) {
					env.axes[i].name = this.value.length == 0 ? undefined : this.value;
					flot.opts.yaxes[i].axisLabel = env.axes[i].name;
					render_axes();
					mkplot();
				}
			}})(i));
			inp.value = env.axes[i].name != undefined ? env.axes[i].name : "";
			inp.id = "popup-inp";
			btns.appendChild(inp);

			return false;
		}})(i));
		td.appendChild(opts);
		tr.appendChild(td);

		var td = document.createElement("td");
		td.className = "axis-keys";
		for (var j=0; j<vars[i].length; j++) {
			var ki = vars[i][j];
			var k = env.plots[ki].key;
			var div = document.createElement("div");
			div.className = "axis-key";

			var col = document.createElement("span");
			col.style.display = "inline";
			col.style.minWidth = "10px";
			col.style.width = "10px";
			col.style.padding = "5px 8px";
			col.style.background = env.plots[ki].color;
			div.appendChild(col);

			var txt = document.createElement("span");
			txt.style.padding = "5px";
			txt.style.display = "inline-block";
			txt.appendChild(document.createTextNode(k));
			div.appendChild(txt);

			div.draggable = "true";
			div.addEventListener("dragstart", (function (key, ax) { return function (e) {
				e.dataTransfer.setData("key", key);
				e.dataTransfer.setData("from", ax);
			}})(k, i+1));

			td.appendChild(div);
		}
		tr.appendChild(td);

		tr.addEventListener('drop', (function (to) { return function (e) {
			e.preventDefault();
			var key = e.dataTransfer.getData("key");
			var from = parseInt(e.dataTransfer.getData("from"));
			if (to != from) move_variable(key, from, to);
			}})(i+1));
		tr.addEventListener('dragover', function (e) {
			e.preventDefault();
		});

		axes.appendChild(tr);
	}
	var tr = document.createElement("tr");
	tr.className = "axis";
	var td = document.createElement("td");
	td.className = "axis-label";
	td.style.cursor = "pointer";
	var span = document.createElement("span");
	span.className = "axis-name";
	span.appendChild(document.createTextNode("New axis"));
	td.addEventListener('click', function () {
		new_axis();
		render_axes();
	});
	td.addEventListener('drop', function (e) {
		e.preventDefault();
		var key = e.dataTransfer.getData("key");
		var from = parseInt(e.dataTransfer.getData("from"));
		new_axis();
		move_variable(key, from, env.axes.length);
	});
	td.addEventListener('dragover', function (e) {
		e.preventDefault();
	});
	td.appendChild(span);

	tr.appendChild(td);
	axes.appendChild(tr);
	if (oldnum != env.axes.length || oldheight != axes.clientHeight ) resize();
	oldnum = env.axes.length;
	oldheight = axes.clientHeight;
}

function move_variable(key, from, to) {
	for (var i=0; i<env.plots.length; i++) {
		if (env.plots[i].key == key) {
			env.plots[i].axis = to;
			flot.data[i].yaxis = to;
		}
	}
	mkplot();
	render_axes();
}

function new_axis() {
	env.axes.push({
		name: undefined,
		position: "left",
		log: false,
	});
	flot.opts.yaxes.push({alignTicksWithAxis: 1});
}

render_axes();

function update_latency(lat) {
	latency.sum += lat;
	latency.num++;
	latency.max = Math.max(latency.max, lat);
	info.innerHTML = 'Latency [last/mean/max]: ' + lat + '/'+Math.round(latency.sum/latency.num)+'/'+latency.max + ' ms';
	if (Object.keys(cache.indices).length > 0) {
		var idx = cache.indices[Object.keys(cache.indices)[0]];
		info2.innerHTML = 'Zoom: '+idx.zoom+', points: '+idx.data.length+', uncompressed: '+Math.round(env.bytes/1024)+' kiB';
	}
}

function select(v) {
	env.frame = v;
	// Yikes, reset the state
	cache.indices = {};
	cache.keys = {};
	cache.old = [];
	env.plots = [];
	env.selection = [0, -1];
	env.points = 200;
	env.axes = [{name: undefined, position: "left"}];
	env.bounds = {};
	env.nav = {cur: 0, history: [[0, -1]]};
	flot.data = [];
	flot.opts.xaxes = [{}];
	flot.opts.yaxes = [{alignTicksWithAxis: 1}];
	flot.plot = null;
	$("#tooltip").hide();
	$("#axis-highlight").hide();
	var st = Date.now();
	mkplot();
	$.getJSON(BASE+'/keys/'+v, function (data, stat, xhr) {
		update_latency(Date.now()-st);
		env.bytes += xhr.responseText.length;
		env.indices = {};
		for (var i=0; i<data.indices.length; i++) {
			env.indices[data.indices[i].name] = {width: data.indices[i].width};
		}
		var keys = data.keys;
		env.keys = {};
		for (var i=0; i<keys.length; i++) {
			var t = keys[i][1];
			var w = keys[i][2];
			var s = ["Int","Float"][t] + {1: "8", 2: "16", 4: "32", 8: "64"}[w];
			env.keys[keys[i][0]] = {index: keys[i][3], type: s, selected: false};
		}
		render_sidebar();
	});	
}

function mkplot() {
	if (flot.data.length != 0) {
		plot.innerHTML = "";
		flot.plot = $.plot("#plot", flot.data, flot.opts);
		$("#plot").unbind("plotselected").bind("plotselected", function (event, ranges) {
			flot.opts.xaxes[0].min = ranges.xaxis.from;
			flot.opts.xaxes[0].max = ranges.xaxis.to;
			env.selection = [Math.floor(ranges.xaxis.from), Math.ceil(ranges.xaxis.to)];
			env.nav.history = env.nav.history.slice(0, env.nav.cur+1);
			env.nav.cur = env.nav.history.length;
			env.nav.history.push(env.selection);
			update_zoom();
			mkplot();
		});


		$("#plot").unbind( "plothover").bind( "plothover", function ( evt, position, item ) {
			if ( item ) {
				// Lock the crosshair to the data point being hovered
				var pos = {};
				pos["x"] = item.datapoint[0];
				pos["y"+item.series.yaxis.n] = item.datapoint[1];
				var o = flot.plot.p2c(pos);
				flot.plot.lockCrosshair(o);
				var x = item.datapoint[0].toFixed(2),
				y = item.datapoint[1].toFixed(2);
				var bg_color = item.series.color.replace(')', ', 0.20)').replace('rgb', 'rgba');
				$("#tooltip").html(item.series.label + "<br>y = " +y +"<br>x = "+ x)
					.css({top: item.pageY+5, 
						left: item.pageX+5, 
						"background-color":bg_color})
					.fadeIn(100);
				var box = item.series.yaxis.box;

				$("#axis-highlight").css({
					position: "absolute",
					top: box.top, 
					left: box.left,
					width: box.width,
					height: box.height,
					"background-color":"white"
					})
					.fadeIn(100);
				item.series.yaxis.box
			} else {
				// Return normal crosshair operation
				flot.plot.unlockCrosshair();
				$("#tooltip").hide();
				$("#axis-highlight").hide();
			}
	    });
	    $("#plot").unbind("plotclick").bind( "plotclick", function ( evt, position, item ) {
	    	if (item) {
	    		flot.plot.highlight(item.seriesIndex,item.dataIndex);
	    		var bg_color = item.series.color.replace(')', ', 0.20)').replace('rgb', 'rgba');
	    		$("#tooltip").clone().appendTo("#yeet").css({top: item.pageY+5, 
						left: item.pageX+5, 
						"background-color":bg_color}).fadeIn(100);;
	    	}
	    });
		var data = flot.plot.getData();
		for (var i=0; i<data.length; i++) {
			env.plots[i].color = data[i].color;
		}
		var ac = document.getElementById("axis-container");
	    ac.innerHTML = "";
	    var ax = flot.plot.getYAxes();
	    var vars = [];
		for (var k=0; k<env.axes.length; k++) vars.push([]);
		for (var i=0; i<env.plots.length; i++) {
			vars[env.plots[i].axis-1].push(i);
		}
		for (var i=0; i<env.axes.length; i++) {
			var box = ax[i].box;
			if (!box) continue;
			var axh = document.createElement("div");
			axh.style.position = "absolute";
			axh.style.top = box.top+"px";
			axh.style.left = box.left+"px";
			axh.style.width = box.width+"px";
			axh.style.height = box.height+"px";
			axh.style.display = "flex";
			axh.style.flexDirection= "column";
			ac.appendChild(axh);
			for (var j=0; j<vars[i].length; j++) {
				var ki = vars[i][j];
				var varh = document.createElement("div");
				varh.style.opacity = 0.15;
				varh.style.background = env.plots[ki].color;
				varh.style.padding = "0px";
				varh.style.display = "block";
				varh.style.flex = 1;
				varh.style.zIndex=1;
				axh.appendChild(varh);
		}}
	} else {
		plot.innerHTML = banner;
		var ac = document.getElementById("axis-container");
	    ac.innerHTML = "";
	}
}

function resetPopup() {
	if(flot.plot){
		flot.plot.unhighlight();
	}
	$(".plot-tooltip").remove();
	$("<div id='tooltip'></div>").css({
		position: "absolute",
		display: "none",
		border: "0px solid #fdd",
		padding: "2px",
	}).addClass("plot-tooltip").appendTo("#yeet");
} 

resetPopup();

var clearint;

function resize() {
	plot.innerHTML = banner;
	plot.style.width = "0px";
	plot.style.height = "0px";
	clearTimeout(clearint);
	clearint = setTimeout(function() {
		var h = plotA.clientHeight;
		var w = plotA.clientWidth;
		env.points = w;
		plot.style.width = ""+w+"px";
		plot.style.height = ""+h+"px";
		plotP.style.paddingTop = "" + ((plotA.clientHeight-h)/2.) + "px";
		mkplot();
	}, 100);
}

clear();
resize();

window.addEventListener('resize', resize);

var st = Date.now();
$.getJSON(BASE+"/frames", function (fr) {
	update_latency(Date.now()-st);
	env.frames = fr.sort();
	render_frames();
	select(fr[0]);
});

filter.addEventListener("keyup", function () {
	if (this.value.length == 0) env.filter = null;
	else env.filter = new RegExp(this.value, 'i');
	render_sidebar();
});

$("<div class='axisTarget' id='axis-highlight'></div>").css({
	position: "absolute",
	display: "none",
	padding: "2px",
	opacity: 0.10,
}).appendTo($("#plot-parent"));

plotP.addEventListener("mouseout", function(){
	$("#tooltip").hide();
});

document.getElementById("axes").addEventListener("mouseover",function(){
	$("#tooltip").hide();
});

btnhelp.addEventListener("click", function (e) {
	e.preventDefault();
	alert("I appreciate your faith. But no, no help yet.");
});

btnconfig.addEventListener("click", function (e) {
	e.preventDefault();
	alert("lol");
});

frames.addEventListener("change", function () {
	select(this.options[this.selectedIndex].value);
});


/*for (var i=0; i<60; i++) {
	add_to_sidebar("lol"+i);
}*/
</script>
</body>
</html>
